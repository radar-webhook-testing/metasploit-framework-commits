module Msf

###
#
# Tcp
# ---
#
# This module provides methods for establish a connection to a remote host and
# communicating with it.
#
###
module Exploit::Remote::Tcp
	
	def initialize(info = {})
		super

		register_options(
			[
				Opt::RHOST,
				Opt::RPORT,
			], Msf::Exploit::Remote::Tcp)
	end

	#
	# Establishes a TCP connection to the specified RHOST/RPORT
	#
	def connect(global = true)
		sock = Rex::Socket::Tcp.create(
			'PeerHost'  => datastore['RHOST'],
			'PeerPort'  => datastore['RPORT'].to_i,
			'LocalHost' => datastore['LHOST'] || "0.0.0.0",
			'LocalPort' => datastore['LPORT'] ? datastore['LPORT'].to_i : 0)

		# Set this socket to the global socket as necessary
		esock = sock if (global)

		return esock
	end

	#
	# Closes the TCP connection
	#
	def disconnect(sock = esock)
		if (sock)
			sock.shutdown
			sock.close
		end

		if (sock == esock)
			esock = nil
		end
	end

protected

	attr_accessor :esock

end

end
